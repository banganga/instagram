<div class="collection-filter">
  <h3 class="collection-filter__title">{{ 'collections.filters.title' | t }}:</h3>
  <h4 class="collection-filter__subtitle">
    {{ 'collections.filters.by_tags' | t }}
    <button type="button" class="icon-fallback-text collection-filter__toggle">
      <span class="icon icon-chevron-thin-down" aria-hidden="true"></span>
      <span class="fallback-text">expand</span>
    </button>
  </h4>
  <ul class="collection-filter__items no-bullets">
    {% for tag in collection.all_tags %}
      {%- assign tag_safe = tag | escape -%}
      {%- assign tag_safe_amp = tag | replace: '&', 'amp' | handle -%}
      <li>
        {% if current_tags contains tag %}
          <label><input type="checkbox" value="{{ tag }}" checked="true"> {{ tag | link_to_remove_tag: tag }}</label>

        {% comment %}
          Workaround for shopify's problem with tags containing ampersands
        {% endcomment %}
        {% elsif current_tags contains tag_safe %}
          <label><input type="checkbox" value="{{ tag }}" checked="true"> {{ tag | link_to_remove_tag: tag_safe }}</label>
        {% elsif current_tags contains tag_safe_amp %}
          <label><input type="checkbox" value="{{ tag }}" checked="true"> {{ tag | link_to_remove_tag: tag_safe_amp }}</label>

        {% else %}
          <label><input type="checkbox" value="{{ tag }}"> {{ tag | link_to_add_tag: tag }}</label>
        {% endif %}
      </li>
    {% endfor %}
    {% if current_tags %}
      <li class="collection-filter__reset">
        <a href="/collections/{{ collection.handle }}">{{ 'collections.filters.reset' | t }}</a>
      </li>
    {% endif %}
  </ul>
</div>